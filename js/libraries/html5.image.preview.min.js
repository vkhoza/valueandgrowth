function previewImage(d,h,i){

var a=d.files;
var c=d.parentNode;
var e=c.getElementsByClassName("imagePreview")[0];
e.innerHTML="Loading...";
var f=a[0];
var g=/image.*/;
var b=detectDevice();
if(!b.android){
	if(!f.type.match(g)){
		var l=document.createElement("p");
		e.innerHTML="";
		l.innerHTML='<div style="color:red;font-size:12px;">This is not a valid Image file</div>';
		e.appendChild(l);
		return
	}
}

var j="";
var k=new FileReader();
k.onload=(function(m){
	return function(r){
		e.innerHTML="";
		var q=r.target.result.split(";");
		q=q[0].split("/");
		q=q[1].toUpperCase();
		if(b.android){
			q=f.name.split(".");
			q=q[q.length-1].toUpperCase()
		}
		if(((q=="JPG")||(q=="PNG")||(q=="GIF"))&&r.total<(i*1024*1024)){
			for(var n in h){
				var p=document.createElement("img");
				var s=r.target.result;
				if(b.android){
					s=s.split(":");
					if(s[1].substr(0,4)=="base"){
						s=s[0]+":image/"+q.toLowerCase()+";"+s[1]
					}
				}
				p.src=s;
				p.style="border-radius:5px;";
				p.id="newimage";
				p.width=h[n];
				p.title="Image preview "+h[n]+"px";
				e.appendChild(p)
			}
		}
		var o=document.createElement("div");
		//o.innerHTML="This is a <b>"+q+"</b> image, size of <b>"+(r.total/1024).toFixed(2)+"</b> KB.";
		if((q!=="JPG")&&(q!=="JPEG")&&(q!=="PNG")&&(q!=="GIF")||(r.total>(i*1024*1024))){
			o.innerHTML+='<br /><span style="color:red;font-size:12px;">This picture is in the wrong format / size! Accepted formats: JPG, PNG, GIF. Size limit is: '+i+"MB</span>"
		}
		else{
		o.innerHTML+='\
		<span id="picupload" style="color:rgb(35,85,165);font-size:12px;">\
			<div id="pictureok">Picture seems to be fine for upload.</div>\
			<table id="apply"><tr><td><button onclick="applypicture(reloadPage);" class="button" style="margin-left:0px;width:70px;">Apply</button></td>\
			<td><img id="loadimage" src="files/loading.gif" style="height:15px;display:none;"/></td><td><div id="loading" style="display:none;">Uploading, please be patient...</div></td></tr></table>\
		</span>'
		}
		e.appendChild(o)
	}
}
)(j);
k.readAsDataURL(f)

}


function detectDevice(){

var a=navigator.userAgent;
var b={
	apple:a.match(/(iPhone|iPod|iPad)/),blackberry:a.match(/BlackBerry/),android:a.match(/Android/),microsoft:a.match(/Windows Phone/),zune:a.match(/ZuneWP7/)
}
;
return b

}
;